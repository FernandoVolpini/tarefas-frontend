<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Minhas Tarefas</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container" style="max-width: 600px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 id="welcome-msg">Tarefas</h2>
            <button onclick="logout()" style="width: auto; background:#6c757d;">Sair</button>
        </div>
        
        <div style="border-bottom: 1px solid #ccc; padding-bottom: 20px; margin-bottom: 20px;">
            <input type="text" id="titulo" placeholder="Título da tarefa (ex: Comprar pão)">
            <textarea id="descricao" placeholder="Descrição detalhada..." rows="3"></textarea>
            <button onclick="adicionarTarefa()">+ Adicionar Tarefa</button>
        </div>

        <div id="lista-tarefas">
            <p style="text-align:center; color:#888;">Carregando...</p>
        </div>
    </div>

    <script>
        const API_URL = "http://localhost:3000";
        const usuarioId = localStorage.getItem('usuario_id');
        const usuarioNome = localStorage.getItem('usuario_nome');

        // Verifica se está logado
        if (!usuarioId) {
            window.location.href = 'index.html';
        } else {
            document.getElementById('welcome-msg').innerText = `Olá, ${usuarioNome}`;
            carregarTarefas();
        }

        // READ - Listar Tarefas
        async function carregarTarefas() {
            const response = await fetch(`${API_URL}/tarefas/${usuarioId}`);
            const tarefas = await response.json();
            
            const listaDiv = document.getElementById('lista-tarefas');
            listaDiv.innerHTML = '';

            tarefas.forEach(tarefa => {
                const item = document.createElement('div');
                item.className = 'task-item';
                item.innerHTML = `
                    <h3>${tarefa.titulo}</h3>
                    <p>${tarefa.descricao}</p>
                    <button class="delete-btn" onclick="deletarTarefa(${tarefa.id})">Excluir</button>
                `;
                listaDiv.appendChild(item);
            });
        }

        // CREATE - Adicionar Tarefa
        async function adicionarTarefa() {
            const titulo = document.getElementById('titulo').value;
            const descricao = document.getElementById('descricao').value;

            if(!titulo) return alert("O título é obrigatório!");

            await fetch(`${API_URL}/tarefas`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    titulo, 
                    descricao, 
                    usuario_id: usuarioId 
                })
            });

            // Limpa campos e recarrega
            document.getElementById('titulo').value = '';
            document.getElementById('descricao').value = '';
            carregarTarefas();
        }

        // DELETE - Excluir Tarefa
        async function deletarTarefa(id) {
            if(confirm("Tem certeza que deseja excluir?")) {
                await fetch(`${API_URL}/tarefas/${id}`, { method: 'DELETE' });
                carregarTarefas();
            }
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>